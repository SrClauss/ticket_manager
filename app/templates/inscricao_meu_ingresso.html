{% extends 'admin/base.html' %}

{% block extra_css %}
<style>
  /* Use admin neomorphist styles and hide admin nav for public page */
  .bottom-nav { display: none !important; }
  .event-hero img { max-height:96px; width:auto; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
  .field-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; }
  .full-width { grid-column: 1 / -1; }
  .search-input, .input { width:100%; padding:0.6rem; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.02); }
  .message { padding:0.6rem 0.8rem; border-radius:6px; }
</style>
{% endblock %}

{% block content %}
<div class=" container mx-auto px-4   flex  justify-content-center  items-center " style="min-height:80vh;">
  <div class="md-card p-4" style="max-width:920px; width:100%;">
    <div class="event-hero mb-3">
      {% if evento.logo_base64 %}
        <img src="data:image/png;base64,{{ evento.logo_base64 }}" alt="{{ evento.nome }}" />
      {% endif %}
      <div>
        <h2 class="mb-0">{{ evento.nome }}</h2>
        <div class="muted">{{ evento.descricao or '' }}</div>
        <div class="muted small">Data: {{ evento.data_evento.strftime('%d/%m/%Y %H:%M') if evento.data_evento else '-' }}</div>
      </div>
    </div>

    {% set slug = evento.nome_normalizado or evento.id or evento['_id'] or evento._id %}

    <!-- Search area -->
    <div class="mb-3">
      <label class="muted small">Buscar ingresso por CPF</label>
      <input id="cpfInput" placeholder="CPF (somente dígitos)" class="search-input" />
      <div id="result" class="mt-2"></div>
    </div>

    <!-- Registration area (always visible) -->
    <div>
      <h5>Cadastro / Emissão de ingresso</h5>
      <p class="muted small">Preencha os campos abaixo. Campos obrigatórios do evento aparecem automaticamente.</p>

      <form id="cadastroForm">
        <div class="field-grid" id="dynamicFields">
          {# Render mandatory fields from evento.campos_obrigatorios_planilha #}
          {% set campos = evento.get('campos_obrigatorios_planilha', []) or [] %}
          {% set lowered = campos | map('lower') | list %}

          {# Ensure standard fields present in order: nome, email, cpf #}
          {% if 'nome' not in lowered %}
            <div class="full-width">
              <label class="muted small">Nome *</label>
              <input id="campo_nome" name="nome" class="input" required />
            </div>
          {% endif %}
          {% if 'email' not in lowered %}
            <div>
              <label class="muted small">Email {% if 'email' in lowered %}*{% endif %}</label>
              <input id="campo_email" name="email" type="email" class="input" />
            </div>
          {% endif %}
          {% if 'cpf' not in lowered %}
            <div>
              <label class="muted small">CPF *</label>
              <input id="campo_cpf" name="cpf" class="input" required />
            </div>
          {% endif %}

          {# Now render fields from the event's list, but only those matching model names we accept #}
          {% for campo in campos %}
            {% set key = campo | lower %}
            {% if key == 'nome' %}
              <div class="full-width">
                <label class="muted small">Nome *</label>
                <input id="campo_nome" name="nome" class="input" required />
              </div>
            {% elif key == 'email' %}
              <div>
                <label class="muted small">Email {% if true %}*{% endif %}</label>
                <input id="campo_email" name="email" type="email" class="input" required />
              </div>
            {% elif key == 'cpf' %}
              <div>
                <label class="muted small">CPF *</label>
                <input id="campo_cpf" name="cpf" class="input" required />
              </div>
            {% elif key == 'telefone' %}
              <div>
                <label class="muted small">Telefone {% if true %}*{% endif %}</label>
                <input id="campo_telefone" name="telefone" class="input" />
              </div>
            {% elif key == 'empresa' %}
              <div class="full-width">
                <label class="muted small">Empresa {% if true %}*{% endif %}</label>
                <input id="campo_empresa" name="empresa" class="input" />
              </div>
            {% elif key == 'nacionalidade' %}
              <div>
                <label class="muted small">Nacionalidade {% if true %}*{% endif %}</label>
                <input id="campo_nacionalidade" name="nacionalidade" class="input" />
              </div>
            {% endif %}
          {% endfor %}

        </div>

        <div class="mt-3  flex  gap-2">
          <button type="button" id="cadastroSubmit" class="btn  inline-flex items-center px-3 py-1 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-100 -gradient">Cadastrar e emitir ingresso</button>
          <button type="reset" id="cadastroReset" class="btn  inline-flex items-center px-3 py-1 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-100 -outline">Limpar</button>
        </div>

        <div id="cadastroMsg" class="mt-2"></div>
      </form>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Hide any admin-only links/styles (defense-in-depth) - already hidden via CSS but keep JS fallback
try { document.querySelectorAll('.bottom-nav').forEach(n=>n.remove()); } catch(e){}

// Search on Enter
const cpfInput = document.getElementById('cpfInput');
cpfInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); buscar(); } });

async function buscar(){
  const cpf = document.getElementById('cpfInput').value || '';
  const result = document.getElementById('result');
  result.innerHTML = '<div class="message muted">Buscando...</div>';
  if(!cpf){ result.innerHTML = '<div class="message warn">Informe o CPF para buscar.</div>'; return; }
  try{
    const resp = await fetch('/api/inscricao/{{ slug }}/buscar-ingresso', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({cpf})
    });
    if(resp.ok){
      const data = await resp.json();
      const ingresso_id = data.ingresso_id;
      result.innerHTML = '<div class="message">Ingresso encontrado. Redirecionando...</div>';
      setTimeout(()=> window.location.href = `/ingresso/${ingresso_id}`, 600);
      return;
    }
    const body = await resp.json().catch(()=>({detail:'Resposta inválida'}));
    if(resp.status === 404){
      result.innerHTML = '<div class="message warn">Nenhum ingresso encontrado para esse CPF. Preencha os dados abaixo para cadastrar.</div>';
      // prefill cpf in form
      const cpfField = document.getElementById('campo_cpf'); if(cpfField) cpfField.value = cpf;
      return;
    }
    result.innerHTML = `<div class="message error">Erro: ${body.detail || JSON.stringify(body)}</div>`;
  }catch(err){ console.error(err); result.innerHTML = '<div class="message error">Erro de rede ao buscar ingresso.</div>'; }
}

// Handle cadastro
async function cadastrar(){
  const msg = document.getElementById('cadastroMsg'); msg.innerHTML = '';
  const form = document.getElementById('cadastroForm');
  const formData = {};
  new FormData(form).forEach((v,k)=>{ formData[k]=v; });
  // basic validation
  if(!formData.nome || !formData.cpf){ msg.innerHTML = '<div class="message error">Nome e CPF são obrigatórios.</div>'; return; }
  msg.innerHTML = 'Enviando...';
  try{
    const resp = await fetch('/inscricao/{{ slug }}', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(formData) });
    const body = await resp.json().catch(()=>({detail:'Resposta inválida'}));
    if(resp.status === 201){
      const ingresso = body.ingresso || {};
      const ingresso_id = body.ingresso_id || ingresso._id || ingresso.id || ingresso['id'];
      msg.innerHTML = '<div class="message">Inscrição realizada com sucesso. Redirecionando...</div>';
      setTimeout(()=>{ if(ingresso_id) window.location.href = `/ingresso/${ingresso_id}`; else window.location.href = '/'; }, 800);
      return;
    }
    msg.innerHTML = `<div class="message error">Erro: ${body.detail || JSON.stringify(body)}</div>`;
  }catch(err){ console.error(err); msg.innerHTML = '<div class="message error">Falha ao enviar inscrição.</div>'; }
}

document.getElementById('cadastroSubmit').addEventListener('click', cadastrar);

</script>
{% endblock %}

{% extends "admin/base.html" %}

{% block title %}Editor de Layout - {{ tipo.descricao if tipo else evento.nome }}{% endblock %}

{% block extra_css %}
<style>
    /* Ticket Canvas Styles */
    .canvas-container {
        position: relative;
        background: white;
        width: 300px;  /* 80mm scaled */
        height: 450px; /* 120mm scaled */
        margin: 0 auto;
        border: 2px dashed #667eea;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .draggable-element {
        position: absolute;
        cursor: move;
        padding: 5px;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid #667eea;
        border-radius: 4px;
        user-select: none;
    }
    
    .draggable-element:hover {
        background: rgba(102, 126, 234, 0.08);
        box-shadow: 6px 6px 12px rgba(163,177,198,0.5), -6px -6px 12px rgba(255,255,255,0.5);
    }
    
    .draggable-element.active {
        box-shadow: 0 0 0 2px #667eea;
    }

    /* Selected element visual */
    .draggable-element.selected {
        outline: 3px dashed var(--primary);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .element-text {
        font-size: 12px;
        color: #333;
        white-space: nowrap;
    }
    
    .element-qrcode {
        width: 60px;
        height: 60px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
    }
    
    .element-logo {
        width: 80px;
        height: 80px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
    }
    
    .control-panel {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .template-tag {
        display: inline-block;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid #667eea;
        border-radius: 4px;
        padding: 2px 8px;
        margin: 2px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .template-tag:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-glass mb-0">Editor de Layout</h1>
                    <p class="text-glass-muted mb-0">{{ evento.nome }}</p>
                </div>
                <a href="{% if evento %}/admin/eventos/{{ evento.id }}{% else %}/admin/eventos{% endif %}" class="btn btn-glass">
                    <i data-lucide="arrow-left" style="width: 20px; height: 20px;"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Frame A: Control Panel -->
    <div class="col-lg-4 mb-4">
        <div class="glass-card p-4 control-panel">
            <h5 class="text-glass mb-3">Painel de Controle</h5>
            
            <!-- Element Type -->
            <div class="mb-3">
                <label class="form-label text-glass">Tipo de Elemento</label>
                <select class="form-select" id="elementType">
                    <option value="text">Texto</option>
                    <option value="qrcode">QR Code</option>
                    <option value="logo">Logo</option>
                </select>
            </div>
            
            <!-- Content Field -->
            <div class="mb-3" id="contentField">
                <label class="form-label text-glass">Conteúdo</label>
                <input type="text" class="form-control" id="elementContent" placeholder="Digite o texto">
                
                <!-- Template Variables -->
                <div class="mt-2">
                    <small class="text-glass-muted d-block mb-2">Tags Inteligentes:</small>
                    <div id="templateTags">
                        <span class="template-tag" data-tag="{NOME}">{NOME}</span>
                        <span class="template-tag" data-tag="{CPF}">{CPF}</span>
                        <span class="template-tag" data-tag="{EMAIL}">{EMAIL}</span>
                        <span class="template-tag" data-tag="{TIPO_INGRESSO}">{TIPO_INGRESSO}</span>
                        <span class="template-tag" data-tag="{EVENTO_NOME}">{EVENTO_NOME}</span>
                        <span class="template-tag" data-tag="{DATA_EVENTO}">{DATA_EVENTO}</span>
                        <span class="template-tag" data-tag="{qrcode_hash}">{qrcode_hash}</span>
                    </div>
                </div>
            </div>
            
            <!-- Font Size (for text) -->
            <div class="mb-3" id="fontSizeField">
                <label class="form-label text-glass">Tamanho da Fonte</label>
                <input type="number" class="form-control" id="fontSize" value="12" min="8" max="72">
            </div>

            <!-- Canvas dimensions -->
            <div class="mb-3">
                <label class="form-label text-glass">Dimensões do Ingresso (mm) — largura x altura</label>
                <div class="d-flex gap-2">
                    <input type="number" id="canvasWidth" class="form-control" min="10" max="62" step="1" placeholder="Largura (mm)">
                    <input type="number" id="canvasHeight" class="form-control" min="10" max="90" step="1" placeholder="Altura (mm)">
                </div>
                <small class="text-glass-muted">Largura máxima 62mm (Brother QL-820NWB). Altura máxima 90mm.</small>
            </div>
            
            <!-- Add Button -->
            <button type="button" class="btn btn-gradient w-100 mb-3" id="addElementBtn">
                <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
                Adicionar ao Layout
            </button>

            <!-- Selected element controls -->
            <div id="selectedControls" style="display:none;" class="mb-3">
                <h6 class="text-glass">Elemento selecionado</h6>
                <div class="mb-2">
                    <label class="form-label text-glass">Conteúdo</label>
                    <input type="text" id="selectedContent" class="form-control" placeholder="Conteúdo do elemento">
                </div>
                <div class="mb-2">
                    <label class="form-label text-glass">Tamanho da Fonte</label>
                    <input type="number" id="selectedSize" class="form-control" min="8" max="120">
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-glass flex-fill" id="updateSelectedBtn">Atualizar</button>
                    <button type="button" class="btn btn-danger flex-fill" id="deleteSelectedBtn">Excluir</button>
                </div>
            </div>

            <hr class="border-light">
            
            <!-- Elements List -->
            <h6 class="text-glass mb-3">Elementos no Layout</h6>
            <div id="elementsList" class="text-glass-muted">
                <small>Nenhum elemento adicionado</small>
            </div>
            
            <hr class="border-light">
            
            <!-- Save Button -->
            <button type="button" class="btn btn-gradient w-100" id="saveLayoutBtn">
                <i data-lucide="save" style="width: 20px; height: 20px;"></i>
                Salvar Layout
            </button>
        </div>
    </div>
    
    <!-- Frame B: Ticket Canvas -->
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <h5 class="text-glass mb-3 text-center">Canvas do Ingresso <span id="canvasSizeLabel">(---)</span></h5>
            
            <div class="canvas-container" id="ticketCanvas" style="width: 300px; height: 450px;">
                <!-- Elements will be added here dynamically -->
            </div>
            
            <div class="mt-3 text-center">
                <small class="text-glass-muted">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    Arraste os elementos para posicioná-los no ingresso
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Hidden input to store layout JSON -->
<input type="hidden" id="layoutJson" value='{{ (tipo.layout_ingresso if tipo else evento.layout_ingresso) | tojson }}'>
<!-- Hidden input: target save URL -->
<input type="hidden" id="saveTarget" value='{{ ("/tipos/layout/" ~ tipo.id) if tipo else ("/eventos/layout/" ~ evento.id) }}'>
{% endblock %}

{% block extra_js %}
<!-- Interact.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script>
    let elements = [];
    let elementCounter = 0;
    
    // Load existing layout
    const existingLayout = JSON.parse(document.getElementById('layoutJson').value);
    const saveTarget = document.getElementById('saveTarget').value;

    // Set canvas size from layout
    const ticketCanvas = document.getElementById('ticketCanvas');
    const canvasSizeLabel = document.getElementById('canvasSizeLabel');
    const canvasWidthInput = document.getElementById('canvasWidth');
    const canvasHeightInput = document.getElementById('canvasHeight');

    function applyCanvasSize(layout) {
        if (!layout || !layout.canvas) return;
        const w = layout.canvas.width || 80;
        const h = layout.canvas.height || 120;
        const unit = layout.canvas.unit || 'mm';
        // Update inline styles (using mm units)
        ticketCanvas.style.width = w + unit;
        ticketCanvas.style.height = h + unit;
        canvasSizeLabel.textContent = `(${w}${unit} x ${h}${unit})`;
        canvasWidthInput.value = w;
        canvasHeightInput.value = h;
    }

    applyCanvasSize(existingLayout);

    if (existingLayout && existingLayout.elements) {
        existingLayout.elements.forEach(el => {
            addElementToCanvas(el.type, el.value, el.x, el.y, el.size);
        });
    }
    
    // Update UI based on element type
    document.getElementById('elementType').addEventListener('change', function() {
        const type = this.value;
        const contentField = document.getElementById('contentField');
        const fontSizeField = document.getElementById('fontSizeField');
        const elementContent = document.getElementById('elementContent');
        
        if (type === 'text') {
            contentField.style.display = 'block';
            fontSizeField.style.display = 'block';
            elementContent.placeholder = 'Digite o texto';
        } else if (type === 'qrcode') {
            contentField.style.display = 'block';
            fontSizeField.style.display = 'none';
            elementContent.placeholder = 'Use {qrcode_hash} para QR Code';
            elementContent.value = '{qrcode_hash}';
        } else if (type === 'logo') {
            contentField.style.display = 'none';
            fontSizeField.style.display = 'none';
        }
    });
    
    // Template tags click
    document.querySelectorAll('.template-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const tagValue = this.getAttribute('data-tag');
            const input = document.getElementById('elementContent');
            input.value += tagValue;
        });
    });

    // Canvas size change handlers
    document.getElementById('canvasWidth').addEventListener('change', function() {
        let w = parseInt(this.value) || 0;
        if (w > 62) { w = 62; this.value = 62; showToast('Largura máxima: 62mm'); }
        if (w < 10) { w = 10; this.value = 10; }
        applyCanvasSize({canvas: {width: w, height: parseInt(document.getElementById('canvasHeight').value) || 0, unit: 'mm'}});
    });

    document.getElementById('canvasHeight').addEventListener('change', function() {
        let h = parseInt(this.value) || 0;
        if (h > 90) { h = 90; this.value = 90; showToast('Altura máxima: 90mm'); }
        if (h < 10) { h = 10; this.value = 10; }
        applyCanvasSize({canvas: {width: parseInt(document.getElementById('canvasWidth').value) || 0, height: h, unit: 'mm'}});
    });
    
    // Add element button
    document.getElementById('addElementBtn').addEventListener('click', function() {
        const type = document.getElementById('elementType').value;
        const content = document.getElementById('elementContent').value;
        const fontSize = document.getElementById('fontSize').value;
        
        if (type !== 'logo' && !content) {
            showToast('Por favor, insira o conteúdo do elemento', 'warning');
            return;
        }
        
        // Add to center of canvas with percentage-based positioning
        addElementToCanvas(type, content, 50, 30, parseInt(fontSize));
        
        // Clear form
        document.getElementById('elementContent').value = '';
    });
    
    function addElementToCanvas(type, value, xPercent, yPercent, size) {
        const canvas = document.getElementById('ticketCanvas');
        const elementId = `element-${elementCounter++}`;
        
        const element = document.createElement('div');
        element.id = elementId;
        element.className = 'draggable-element';
        element.setAttribute('data-type', type);
        element.setAttribute('data-value', value || '');
        element.setAttribute('data-size', size || 12);
        
        if (type === 'text') {
            element.innerHTML = `<span class="element-text" style="font-size: ${size}px">${value}</span>`;
        } else if (type === 'qrcode') {
            element.innerHTML = '<div class="element-qrcode">QR CODE</div>';
        } else if (type === 'logo') {
            element.innerHTML = '<div class="element-logo">LOGO</div>';
        }
        
        // Set position using percentage
        element.style.left = xPercent + '%';
        element.style.top = yPercent + '%';
        
        canvas.appendChild(element);
        
        // Make it draggable
        interact(`#${elementId}`).draggable({
            inertia: true,
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ],
            autoScroll: true,
            listeners: {
                move: dragMoveListener,
            }
        });
        
        // Click to select element
        element.addEventListener('click', function(e) {
            e.stopPropagation();
            selectElement(elementId);
        });

        // Double-click to remove as before
        element.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            if (confirm('Deseja remover este elemento?')) {
                element.remove();
                clearSelection();
                updateElementsList();
            }
        });
        
        updateElementsList();
    }

    // Select / edit helpers
    let selectedElementId = null;

    function selectElement(id) {
        clearSelection();
        const el = document.getElementById(id);
        if (!el) return;
        selectedElementId = id;
        el.classList.add('selected');
        // Populate controls
        document.getElementById('selectedControls').style.display = 'block';
        document.getElementById('selectedContent').value = el.getAttribute('data-value') || '';
        document.getElementById('selectedSize').value = el.getAttribute('data-size') || 12;
    }

    function clearSelection() {
        if (selectedElementId) {
            const prev = document.getElementById(selectedElementId);
            if (prev) prev.classList.remove('selected');
        }
        selectedElementId = null;
        document.getElementById('selectedControls').style.display = 'none';
    }

    document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
        if (!selectedElementId) return;
        const el = document.getElementById(selectedElementId);
        if (el && confirm('Deseja remover o elemento selecionado?')) {
            el.remove();
            clearSelection();
            updateElementsList();
        }
    });

    document.getElementById('updateSelectedBtn').addEventListener('click', function() {
        if (!selectedElementId) return;
        const el = document.getElementById(selectedElementId);
        if (!el) return;
        const newVal = document.getElementById('selectedContent').value;
        const newSize = parseInt(document.getElementById('selectedSize').value) || 12;
        el.setAttribute('data-value', newVal);
        el.setAttribute('data-size', newSize);
        // Update inner html depending on type
        const type = el.getAttribute('data-type');
        if (type === 'text') {
            el.innerHTML = `<span class="element-text" style="font-size: ${newSize}px">${newVal}</span>`;
        } else if (type === 'qrcode') {
            el.setAttribute('data-value', '{qrcode_hash}');
            el.innerHTML = '<div class="element-qrcode">QR CODE</div>';
        }
        updateElementsList();
    });

    // Clear selection when clicking outside
    document.getElementById('ticketCanvas').addEventListener('click', function() {
        clearSelection();
    });

    // Delete with Delete/Backspace key
    document.addEventListener('keydown', function(e) {
        if (!selectedElementId) return;
        if (e.key === 'Delete' || e.key === 'Backspace') {
            const el = document.getElementById(selectedElementId);
            if (el && confirm('Deseja remover o elemento selecionado?')) {
                el.remove();
                clearSelection();
                updateElementsList();
            }
        }
    });
    
    function dragMoveListener(event) {
        var target = event.target;
        var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
        
        target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }
    
    function updateElementsList() {
        const canvas = document.getElementById('ticketCanvas');
        const listDiv = document.getElementById('elementsList');
        const elements = canvas.querySelectorAll('.draggable-element');
        
        if (elements.length === 0) {
            listDiv.innerHTML = '<small>Nenhum elemento adicionado</small>';
            return;
        }
        
        let html = '<div class="list-group">';
        elements.forEach((el, index) => {
            const type = el.getAttribute('data-type');
            const value = el.getAttribute('data-value');
            html += `
                <div class="list-group-item glass-card mb-2 p-2">
                    <small>
                        <strong>${type.toUpperCase()}</strong><br>
                        ${value ? value.substring(0, 30) : 'Logo'}
                    </small>
                </div>
            `;
        });
        html += '</div>';
        listDiv.innerHTML = html;
    }
    
    // Save layout
    document.getElementById('saveLayoutBtn').addEventListener('click', async function() {
        const canvas = document.getElementById('ticketCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        const elements = canvas.querySelectorAll('.draggable-element');
        
        // Read canvas dimensions from inputs
        const w = parseInt(document.getElementById('canvasWidth').value) || 0;
        const h = parseInt(document.getElementById('canvasHeight').value) || 0;
        if (w <= 0 || h <= 0) {
            showToast('Defina as dimensões do ingresso antes de salvar', 'warning');
            return;
        }
        if (w > 62 || h > 90) {
            showToast('Dimensões excedem o máximo permitido (62x90mm)', 'warning');
            return;
        }

        const layout = {
            canvas: {
                width: w,
                height: h,
                unit: 'mm'
            },
            elements: []
        };
        
        elements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const x = parseFloat(el.getAttribute('data-x')) || 0;
            const y = parseFloat(el.getAttribute('data-y')) || 0;
            
            // Calculate percentage position relative to canvas
            const xPercent = ((rect.left - canvasRect.left + x) / canvasRect.width) * 100;
            const yPercent = ((rect.top - canvasRect.top + y) / canvasRect.height) * 100;
            
            layout.elements.push({
                type: el.getAttribute('data-type'),
                value: el.getAttribute('data-value'),
                x: Math.round(xPercent * 10) / 10,  // Round to 1 decimal
                y: Math.round(yPercent * 10) / 10,
                size: parseInt(el.getAttribute('data-size')) || 12
            });
        });
        
        // Send to backend to the dynamic save target
        try {
            const response = await fetch(saveTarget, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ layout_ingresso: layout })
            });
            
            if (response.ok) {
                showToast('Layout salvo com sucesso!', 'success');
            } else {
                showToast('Erro ao salvar layout', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Erro ao salvar layout', 'danger');
        }
    });
    
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        const container = document.querySelector('.toast-container');
        container.innerHTML = toastHtml;
        const toastEl = container.querySelector('.toast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>
{% endblock %}

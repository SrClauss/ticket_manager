{% extends "admin/base.html" %}

{% block title %}Editor de Layout - {{ evento.nome }}{% endblock %}

{% block extra_css %}
<style>
    /* Ticket Canvas Styles */
    .canvas-container {
        position: relative;
        background: white;
        width: 300px;  /* 80mm scaled */
        height: 450px; /* 120mm scaled */
        margin: 0 auto;
        border: 2px dashed #667eea;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .draggable-element {
        position: absolute;
        cursor: move;
        padding: 5px;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid #667eea;
        border-radius: 4px;
        user-select: none;
    }
    
    .draggable-element:hover {
        background: rgba(102, 126, 234, 0.2);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .draggable-element.active {
        box-shadow: 0 0 0 2px #667eea;
    }
    
    .element-text {
        font-size: 12px;
        color: #333;
        white-space: nowrap;
    }
    
    .element-qrcode {
        width: 60px;
        height: 60px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
    }
    
    .element-logo {
        width: 80px;
        height: 80px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
    }
    
    .control-panel {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .template-tag {
        display: inline-block;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid #667eea;
        border-radius: 4px;
        padding: 2px 8px;
        margin: 2px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .template-tag:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-glass mb-0">Editor de Layout</h1>
                    <p class="text-glass-muted mb-0">{{ evento.nome }}</p>
                </div>
                <a href="/admin/eventos" class="btn btn-glass">
                    <i data-lucide="arrow-left" style="width: 20px; height: 20px;"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Frame A: Control Panel -->
    <div class="col-lg-4 mb-4">
        <div class="glass-card p-4 control-panel">
            <h5 class="text-glass mb-3">Painel de Controle</h5>
            
            <!-- Element Type -->
            <div class="mb-3">
                <label class="form-label text-glass">Tipo de Elemento</label>
                <select class="form-select" id="elementType">
                    <option value="text">Texto</option>
                    <option value="qrcode">QR Code</option>
                    <option value="logo">Logo</option>
                </select>
            </div>
            
            <!-- Content Field -->
            <div class="mb-3" id="contentField">
                <label class="form-label text-glass">Conteúdo</label>
                <input type="text" class="form-control" id="elementContent" placeholder="Digite o texto">
                
                <!-- Template Variables -->
                <div class="mt-2">
                    <small class="text-glass-muted d-block mb-2">Tags Inteligentes:</small>
                    <div id="templateTags">
                        <span class="template-tag" data-tag="{NOME}">{NOME}</span>
                        <span class="template-tag" data-tag="{CPF}">{CPF}</span>
                        <span class="template-tag" data-tag="{EMAIL}">{EMAIL}</span>
                        <span class="template-tag" data-tag="{TIPO_INGRESSO}">{TIPO_INGRESSO}</span>
                        <span class="template-tag" data-tag="{EVENTO_NOME}">{EVENTO_NOME}</span>
                        <span class="template-tag" data-tag="{DATA_EVENTO}">{DATA_EVENTO}</span>
                        <span class="template-tag" data-tag="{qrcode_hash}">{qrcode_hash}</span>
                    </div>
                </div>
            </div>
            
            <!-- Font Size (for text) -->
            <div class="mb-3" id="fontSizeField">
                <label class="form-label text-glass">Tamanho da Fonte</label>
                <input type="number" class="form-control" id="fontSize" value="12" min="8" max="72">
            </div>
            
            <!-- Add Button -->
            <button type="button" class="btn btn-gradient w-100 mb-3" id="addElementBtn">
                <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
                Adicionar ao Layout
            </button>
            
            <hr class="border-light">
            
            <!-- Elements List -->
            <h6 class="text-glass mb-3">Elementos no Layout</h6>
            <div id="elementsList" class="text-glass-muted">
                <small>Nenhum elemento adicionado</small>
            </div>
            
            <hr class="border-light">
            
            <!-- Save Button -->
            <button type="button" class="btn btn-gradient w-100 mb-2" id="saveLayoutBtn">
                <i data-lucide="save" style="width: 20px; height: 20px;"></i>
                Salvar Layout
            </button>
            
            <!-- Clear Button -->
            <button type="button" class="btn btn-danger w-100" id="clearLayoutBtn">
                <i data-lucide="trash-2" style="width: 20px; height: 20px;"></i>
                Limpar Tudo
            </button>
        </div>
    </div>
    
    <!-- Frame B: Ticket Canvas -->
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <h5 class="text-glass mb-3 text-center">Canvas do Ingresso (80mm x 120mm)</h5>
            
            <div class="canvas-container" id="ticketCanvas">
                <!-- Elements will be added here dynamically -->
            </div>
            
            <div class="mt-3 text-center">
                <small class="text-glass-muted">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    Arraste os elementos para posicioná-los no ingresso
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Hidden input to store layout JSON -->
<input type="hidden" id="layoutJson" value='{{ evento.layout_ingresso | tojson }}'>
{% endblock %}

{% block extra_js %}
<!-- Interact.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script>
    let elements = [];
    let elementCounter = 0;
    let selectedElement = null;
    let longPressTimer = null;
    const LONG_PRESS_MS = 500;

    // Read existing layout JSON
    const existingLayout = JSON.parse(document.getElementById('layoutJson').value || '{}');
    console.log('Loading existing layout from DB:', existingLayout);

    // Default canvas padding (mm) and border
    const defaultPadding = (existingLayout && existingLayout.canvas && existingLayout.canvas.padding_mm) ? existingLayout.canvas.padding_mm : 5;
    const defaultBorder = (existingLayout && existingLayout.canvas && existingLayout.canvas.border) ? existingLayout.canvas.border : false;

    // Create controls for padding and border in the UI
    const controlPanel = document.querySelector('.control-panel');
    const padHtml = `
        <div class="mb-3">
            <label class="form-label text-glass">Padding do Canvas (mm)</label>
            <input type="number" class="form-control" id="canvasPadding" value="${defaultPadding}" min="0" step="0.5">
        </div>
        <div class="mb-3 form-check form-switch">
            <input class="form-check-input" type="checkbox" id="canvasBorder" ${defaultBorder ? 'checked' : ''}>
            <label class="form-check-label text-glass" for="canvasBorder">Mostrar borda do ingresso</label>
        </div>
        <div class="mb-3" id="selectedControls" style="display:none;">
            <label class="form-label text-glass">Margin do elemento (mm)</label>
            <input type="number" class="form-control" id="elementMargin" value="0" min="0" step="0.5">
        </div>
    `;
    controlPanel.insertAdjacentHTML('afterbegin', padHtml);

    // Apply canvas border visual
    function applyCanvasBorder() {
        const canvas = document.getElementById('ticketCanvas');
        const show = document.getElementById('canvasBorder').checked;
        if (show) {
            canvas.style.border = '2px solid #333';
        } else {
            canvas.style.border = '2px dashed #667eea';
        }
    }
    applyCanvasBorder();
    document.getElementById('canvasBorder').addEventListener('change', applyCanvasBorder);

    // Load existing elements (if any)
    if (existingLayout && Array.isArray(existingLayout.elements)) {
        existingLayout.elements.forEach(el => {
            addElementToCanvas(el.type, el.value, el.x || 40, el.y || 60, el.size || 12, el.margin_mm || 0);
        });
    }

    // Element type change handler
    document.getElementById('elementType').addEventListener('change', function() {
        const type = this.value;
        const contentField = document.getElementById('contentField');
        const fontSizeField = document.getElementById('fontSizeField');
        const elementContent = document.getElementById('elementContent');

        if (type === 'text') {
            contentField.style.display = 'block';
            fontSizeField.style.display = 'block';
            elementContent.placeholder = 'Digite o texto';
        } else if (type === 'qrcode') {
            contentField.style.display = 'block';
            fontSizeField.style.display = 'none';
            elementContent.placeholder = 'Use {qrcode_hash} para QR Code';
            elementContent.value = '{qrcode_hash}';
        } else if (type === 'logo') {
            contentField.style.display = 'none';
            fontSizeField.style.display = 'none';
        }
    });

    // Template tags click
    document.querySelectorAll('.template-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const tagValue = this.getAttribute('data-tag');
            const input = document.getElementById('elementContent');
            input.value += tagValue;
        });
    });

    // Add element button
    document.getElementById('addElementBtn').addEventListener('click', function() {
        const type = document.getElementById('elementType').value;
        const content = document.getElementById('elementContent').value;
        const fontSize = document.getElementById('fontSize').value;

        if (type !== 'logo' && !content) {
            showToast('Por favor, insira o conteúdo do elemento', 'warning');
            return;
        }

        addElementToCanvas(type, content, 40, 60, parseInt(fontSize));
        document.getElementById('elementContent').value = '';
    });

    // Create toolbar element (hidden) for long-press actions
    const toolbar = document.createElement('div');
    toolbar.id = 'elementToolbar';
    toolbar.style.position = 'absolute';
    toolbar.style.display = 'none';
    toolbar.style.zIndex = 9999;
    toolbar.style.background = 'rgba(0,0,0,0.8)';
    toolbar.style.color = 'white';
    toolbar.style.padding = '6px';
    toolbar.style.borderRadius = '6px';
    toolbar.innerHTML = `
        <button class="btn btn-sm btn-light me-1" data-action="align-left" title="Alinhar à esquerda"><i data-lucide="align-left" style="width:16px;height:16px"></i></button>
        <button class="btn btn-sm btn-light me-1" data-action="align-center" title="Centralizar"><i data-lucide="align-center" style="width:16px;height:16px"></i></button>
        <button class="btn btn-sm btn-light me-1" data-action="align-right" title="Alinhar à direita"><i data-lucide="align-right" style="width:16px;height:16px"></i></button>
        <button class="btn btn-sm btn-danger" data-action="delete" title="Excluir"><i data-lucide="trash-2" style="width:16px;height:16px"></i></button>
    `;
    document.body.appendChild(toolbar);
    // initialize lucide icons in the injected toolbar
    try { if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') { lucide.createIcons(); } } catch (e) { console.warn('lucide init failed', e); }

    // Add element to canvas
    function addElementToCanvas(type, value, xMm, yMm, size, marginMm) {
        const canvas = document.getElementById('ticketCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        const elementId = `element-${elementCounter++}`;

        const element = document.createElement('div');
        element.id = elementId;
        element.className = 'draggable-element';
        element.setAttribute('data-type', type);
        element.setAttribute('data-value', value || '');
        element.setAttribute('data-size', size || 12);
        element.setAttribute('data-margin-mm', marginMm || 0);

        if (type === 'text') {
            element.innerHTML = `<span class="element-text" style="font-size: ${size}px">${value}</span>`;
        } else if (type === 'qrcode') {
            element.innerHTML = '<div class="element-qrcode">QR CODE</div>';
        } else if (type === 'logo') {
            element.innerHTML = '<div class="element-logo">LOGO</div>';
        }

        // Position using mm -> px conversion
        const canvasW = canvasRect.width;
        const canvasH = canvasRect.height;
        const leftPx = (xMm / 80) * canvasW;
        const topPx = (yMm / 120) * canvasH;

        element.style.left = Math.max(0, Math.min(leftPx, canvasW - 10)) + 'px';
        element.style.top = Math.max(0, Math.min(topPx, canvasH - 10)) + 'px';
        element.style.transform = 'translate(0px, 0px)';
        element.setAttribute('data-x', 0);
        element.setAttribute('data-y', 0);

        // Click selects element
        element.addEventListener('click', function(e) {
            e.stopPropagation();
            selectElement(element);
        });

        // Long-press to show toolbar
        element.addEventListener('pointerdown', function(e) {
            longPressTimer = setTimeout(() => {
                showToolbarForElement(element, e.clientX, e.clientY);
            }, LONG_PRESS_MS);
        });
        element.addEventListener('pointerup', function() { clearLongPress(); });
        element.addEventListener('pointerleave', function() { clearLongPress(); });

        // Double-click to delete
        element.addEventListener('dblclick', function() {
            if (confirm('Deseja remover este elemento?')) {
                element.remove();
                if (selectedElement === element) selectedElement = null;
                updateElementsList();
            }
        });

        canvas.appendChild(element);

        // Make draggable
        interact(element).draggable({
            inertia: true,
            modifiers: [
                interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })
            ],
            listeners: { move: dragMoveListener }
        });

        updateElementsList();
    }

    function clearLongPress() {
        if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
    }

    function showToolbarForElement(el, clientX, clientY) {
        toolbar.style.left = (clientX + 8) + 'px';
        toolbar.style.top = (clientY + 8) + 'px';
        toolbar.style.display = 'block';
        // Attach actions
        toolbar.querySelectorAll('button').forEach(btn => {
            btn.onclick = function(ev) {
                const action = this.getAttribute('data-action');
                handleToolbarAction(el, action);
                toolbar.style.display = 'none';
            };
        });
    }

    // Hide toolbar when clicking elsewhere
    document.addEventListener('click', () => { toolbar.style.display = 'none'; selectElement(null); });

    function handleToolbarAction(el, action) {
        const canvas = document.getElementById('ticketCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        const paddingMm = parseFloat(document.getElementById('canvasPadding').value || '5');
        const paddingPx = (paddingMm / 80) * canvasRect.width;
        const elRect = el.getBoundingClientRect();
        const elW = elRect.width;

        if (action === 'delete') {
            if (confirm('Remover este elemento?')) { el.remove(); updateElementsList(); }
            return;
        }

        // Compute new left in px
        let newLeftPx = parseFloat(el.style.left || 0);
        if (action === 'align-left') {
            newLeftPx = paddingPx;
        } else if (action === 'align-center') {
            newLeftPx = (canvasRect.width - elW) / 2;
        } else if (action === 'align-right') {
            newLeftPx = canvasRect.width - paddingPx - elW;
        }

        // Preserve current vertical visual position (including any translate) before clearing transform
        const currentTopPx = el.getBoundingClientRect().top - canvasRect.top;
        const clampedTop = Math.max(0, Math.min(currentTopPx, canvasRect.height - elRect.height));
        el.style.top = clampedTop + 'px';

        // Apply horizontal position and reset transform/data-x
        el.style.left = Math.max(0, Math.min(newLeftPx, canvasRect.width - elW)) + 'px';
        el.style.transform = 'translate(0px, 0px)';
        el.setAttribute('data-x', 0);
        el.setAttribute('data-y', 0);

        updateElementsList();
    }

    function selectElement(el) {
        // Deselect previous
        if (selectedElement) selectedElement.classList.remove('active');
        selectedElement = el;
        const selControls = document.getElementById('selectedControls');
        if (!el) {
            selControls.style.display = 'none';
            return;
        }
        el.classList.add('active');
        selControls.style.display = 'block';
        document.getElementById('elementMargin').value = el.getAttribute('data-margin-mm') || 0;

        // When margin changed, update element dataset
        document.getElementById('elementMargin').onchange = function() {
            el.setAttribute('data-margin-mm', this.value);
        };
    }

    function dragMoveListener(event) {
        var target = event.target;
        var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

        target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }

    function updateElementsList() {
        const canvas = document.getElementById('ticketCanvas');
        const listDiv = document.getElementById('elementsList');
        const elems = canvas.querySelectorAll('.draggable-element');

        if (elems.length === 0) {
            listDiv.innerHTML = '<small>Nenhum elemento adicionado</small>';
            return;
        }

        let html = '<div class="list-group">';
        elems.forEach((el, index) => {
            const type = el.getAttribute('data-type');
            const value = el.getAttribute('data-value');
            const id = el.id;
            html += `
                <div class="list-group-item glass-card mb-2 p-2" data-el-id="${id}">
                    <small>
                        <strong>${type.toUpperCase()}</strong><br>
                        ${value ? value.substring(0, 30) : 'Logo'}
                    </small>
                </div>
            `;
        });
        html += '</div>';
        listDiv.innerHTML = html;

        // Attach click to select from list
        listDiv.querySelectorAll('[data-el-id]').forEach(node => {
            node.onclick = function(e) {
                e.stopPropagation();
                const elId = this.getAttribute('data-el-id');
                const el = document.getElementById(elId);
                if (el) selectElement(el);
            };
        });
    }

    // Save layout (includes canvas padding and border state, element margins)
    document.getElementById('saveLayoutBtn').addEventListener('click', async function() {
        const canvas = document.getElementById('ticketCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        const elems = canvas.querySelectorAll('.draggable-element');

        const layout = {
            canvas: {
                width: 80,
                height: 120,
                unit: 'mm',
                padding_mm: parseFloat(document.getElementById('canvasPadding').value || '5'),
                border: document.getElementById('canvasBorder').checked
            },
            elements: []
        };

        elems.forEach(el => {
            // Compute element position in pixels relative to canvas left/top
            const elRect = el.getBoundingClientRect();
            const leftPx = elRect.left - canvasRect.left;
            const topPx = elRect.top - canvasRect.top;

            // Convert px->mm
            const xMm = Math.max(0, (leftPx / canvasRect.width) * layout.canvas.width);
            const yMm = Math.max(0, (topPx / canvasRect.height) * layout.canvas.height);

            layout.elements.push({
                type: el.getAttribute('data-type'),
                value: el.getAttribute('data-value'),
                x: Math.round(xMm * 10) / 10,
                y: Math.round(yMm * 10) / 10,
                size: parseInt(el.getAttribute('data-size')) || 12,
                margin_mm: parseFloat(el.getAttribute('data-margin-mm')) || 0
            });
        });

        console.log('Saving layout with mm coordinates and canvas padding:', layout);

        try {
            const response = await fetch('/admin/eventos/layout/{{ evento.id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ layout_ingresso: layout })
            });
            if (response.ok) showToast('Layout salvo com sucesso!', 'success');
            else { console.error('Save failed', await response.text()); showToast('Erro ao salvar layout', 'danger'); }
        } catch (err) { console.error(err); showToast('Erro ao salvar layout', 'danger'); }
    });

    // Clear all elements
    document.getElementById('clearLayoutBtn').addEventListener('click', function() {
        if (confirm('Deseja remover TODOS os elementos do layout?')) {
            const canvas = document.getElementById('ticketCanvas');
            canvas.innerHTML = '';
            updateElementsList();
            showToast('Layout limpo', 'success');
        }
    });

    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        const container = document.querySelector('.toast-container');
        if (!container) return;
        container.innerHTML = toastHtml;
        const toastEl = container.querySelector('.toast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>
{% endblock %}

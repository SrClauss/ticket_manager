{% extends "admin/base.html" %}

{% block title %}Editor de Layout - {{ evento.nome }}{% endblock %}

{% block extra_css %}
<style>
    /* Ticket Canvas Styles */
    .canvas-container {
        position: relative;
        background: white;
        width: 300px;  /* 80mm scaled */
        height: 450px; /* 120mm scaled */
        margin: 0 auto;
        border: 2px dashed #667eea;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .draggable-element {
        position: absolute;
        cursor: move;
        padding: 5px;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid #667eea;
        border-radius: 4px;
        user-select: none;
    }
    
    .draggable-element:hover {
        background: rgba(102, 126, 234, 0.2);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .draggable-element.active {
        box-shadow: 0 0 0 2px #667eea;
    }
    
    .element-text {
        font-size: 12px;
        color: #333;
        white-space: nowrap;
    }
    
    .element-qrcode {
        width: 60px;
        height: 60px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
    }
    
    .element-logo {
        width: 80px;
        height: 80px;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
    }
    
    .control-panel {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .template-tag {
        display: inline-block;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid #667eea;
        border-radius: 4px;
        padding: 2px 8px;
        margin: 2px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .template-tag:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-glass mb-0">Editor de Layout</h1>
                    <p class="text-glass-muted mb-0">{{ evento.nome }}</p>
                </div>
                <a href="/admin/eventos" class="btn btn-glass">
                    <i data-lucide="arrow-left" style="width: 20px; height: 20px;"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Frame A: Control Panel -->
    <div class="col-lg-4 mb-4">
        <div class="glass-card p-4 control-panel">
            <h5 class="text-glass mb-3">Painel de Controle</h5>
            
            <!-- Element Type -->
            <div class="mb-3">
                <label class="form-label text-glass">Tipo de Elemento</label>
                <select class="form-select" id="elementType">
                    <option value="text">Texto</option>
                    <option value="qrcode">QR Code</option>
                    <option value="logo">Logo</option>
                </select>
            </div>
            
            <!-- Content Field -->
            <div class="mb-3" id="contentField">
                <label class="form-label text-glass">Conteúdo</label>
                <input type="text" class="form-control" id="elementContent" placeholder="Digite o texto">
                
                <!-- Template Variables -->
                <div class="mt-2">
                    <small class="text-glass-muted d-block mb-2">Tags Inteligentes:</small>
                    <div id="templateTags">
                        <span class="template-tag" data-tag="{NOME}">{NOME}</span>
                        <span class="template-tag" data-tag="{CPF}">{CPF}</span>
                        <span class="template-tag" data-tag="{EMAIL}">{EMAIL}</span>
                        <span class="template-tag" data-tag="{TIPO_INGRESSO}">{TIPO_INGRESSO}</span>
                        <span class="template-tag" data-tag="{EVENTO_NOME}">{EVENTO_NOME}</span>
                        <span class="template-tag" data-tag="{DATA_EVENTO}">{DATA_EVENTO}</span>
                        <span class="template-tag" data-tag="{qrcode_hash}">{qrcode_hash}</span>
                    </div>
                </div>
            </div>
            
            <!-- Font Size (for text) -->
            <div class="mb-3" id="fontSizeField">
                <label class="form-label text-glass">Tamanho da Fonte</label>
                <input type="number" class="form-control" id="fontSize" value="12" min="8" max="72">
            </div>
            
            <!-- Add Button -->
            <button type="button" class="btn btn-gradient w-100 mb-3" id="addElementBtn">
                <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
                Adicionar ao Layout
            </button>
            
            <hr class="border-light">
            
            <!-- Elements List -->
            <h6 class="text-glass mb-3">Elementos no Layout</h6>
            <div id="elementsList" class="text-glass-muted">
                <small>Nenhum elemento adicionado</small>
            </div>
            
            <hr class="border-light">
            
            <!-- Save Button -->
            <button type="button" class="btn btn-gradient w-100 mb-2" id="saveLayoutBtn">
                <i data-lucide="save" style="width: 20px; height: 20px;"></i>
                Salvar Layout
            </button>
            
            <!-- Clear Button -->
            <button type="button" class="btn btn-danger w-100" id="clearLayoutBtn">
                <i data-lucide="trash-2" style="width: 20px; height: 20px;"></i>
                Limpar Tudo
            </button>
        </div>
    </div>
    
    <!-- Frame B: Ticket Canvas -->
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <h5 class="text-glass mb-3 text-center">Canvas do Ingresso (80mm x 120mm)</h5>
            
            <div class="canvas-container" id="ticketCanvas">
                <!-- Elements will be added here dynamically -->
            </div>
            
            <div class="mt-3 text-center">
                <small class="text-glass-muted">
                    <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                    Arraste os elementos para posicioná-los no ingresso
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Hidden input to store layout JSON -->
<input type="hidden" id="layoutJson" value='{{ evento.layout_ingresso | tojson }}'>
{% endblock %}

{% block extra_js %}
<!-- Interact.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script>
    let elements = [];
    let elementCounter = 0;
    
    // Load existing layout
    const existingLayout = JSON.parse(document.getElementById('layoutJson').value);
    console.log('Loading existing layout from DB:', existingLayout);
    if (existingLayout && existingLayout.elements) {
        existingLayout.elements.forEach(el => {
            console.log(`Loading element: type=${el.type}, x=${el.x}mm, y=${el.y}mm, value=${el.value}`);
            // Now passing coordinates in mm (not percentage)
            addElementToCanvas(el.type, el.value, el.x, el.y, el.size);
        });
    }
    
    // Update UI based on element type
    document.getElementById('elementType').addEventListener('change', function() {
        const type = this.value;
        const contentField = document.getElementById('contentField');
        const fontSizeField = document.getElementById('fontSizeField');
        const elementContent = document.getElementById('elementContent');
        
        if (type === 'text') {
            contentField.style.display = 'block';
            fontSizeField.style.display = 'block';
            elementContent.placeholder = 'Digite o texto';
        } else if (type === 'qrcode') {
            contentField.style.display = 'block';
            fontSizeField.style.display = 'none';
            elementContent.placeholder = 'Use {qrcode_hash} para QR Code';
            elementContent.value = '{qrcode_hash}';
        } else if (type === 'logo') {
            contentField.style.display = 'none';
            fontSizeField.style.display = 'none';
        }
    });
    
    // Template tags click
    document.querySelectorAll('.template-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const tagValue = this.getAttribute('data-tag');
            const input = document.getElementById('elementContent');
            input.value += tagValue;
        });
    });
    
    // Add element button
    document.getElementById('addElementBtn').addEventListener('click', function() {
        const type = document.getElementById('elementType').value;
        const content = document.getElementById('elementContent').value;
        const fontSize = document.getElementById('fontSize').value;
        
        if (type !== 'logo' && !content) {
            showToast('Por favor, insira o conteúdo do elemento', 'warning');
            return;
        }
        
        // Add to center of canvas (40mm x 60mm in an 80mm x 120mm canvas)
        addElementToCanvas(type, content, 40, 60, parseInt(fontSize));
        
        // Clear form
        document.getElementById('elementContent').value = '';
    });
    
    function addElementToCanvas(type, value, xMm, yMm, size) {
        const canvas = document.getElementById('ticketCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        const elementId = `element-${elementCounter++}`;
        
        const element = document.createElement('div');
        element.id = elementId;
        element.className = 'draggable-element';
        element.setAttribute('data-type', type);
        element.setAttribute('data-value', value || '');
        element.setAttribute('data-size', size || 12);
        
        if (type === 'text') {
            element.innerHTML = `<span class="element-text" style="font-size: ${size}px">${value}</span>`;
        } else if (type === 'qrcode') {
            element.innerHTML = '<div class="element-qrcode">QR CODE</div>';
        } else if (type === 'logo') {
            element.innerHTML = '<div class="element-logo">LOGO</div>';
        }
        
        // Convert mm to pixels for initial positioning
        // Canvas is 80mm x 120mm displayed in canvasRect.width x canvasRect.height pixels
        const xPx = (xMm / 80) * canvasRect.width;
        const yPx = (yMm / 120) * canvasRect.height;
        
        // Clamp to canvas bounds (in pixels)
        const clampedX = Math.max(0, Math.min(xPx, canvasRect.width - 50)); // -50 for element width estimate
        const clampedY = Math.max(0, Math.min(yPx, canvasRect.height - 30)); // -30 for element height estimate
        
        element.style.left = clampedX + 'px';
        element.style.top = clampedY + 'px';
        element.setAttribute('data-x', 0);
        element.setAttribute('data-y', 0);
        
        canvas.appendChild(element);
        
        // Make it draggable
        interact(`#${elementId}`).draggable({
            inertia: true,
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ],
            autoScroll: true,
            listeners: {
                move: dragMoveListener,
            }
        });
        
        // Add delete button
        element.addEventListener('dblclick', function() {
            if (confirm('Deseja remover este elemento?')) {
                element.remove();
                updateElementsList();
            }
        });
        
        updateElementsList();
    }
    
    function dragMoveListener(event) {
        var target = event.target;
        var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
        
        target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }
    
    function updateElementsList() {
        const canvas = document.getElementById('ticketCanvas');
        const listDiv = document.getElementById('elementsList');
        const elements = canvas.querySelectorAll('.draggable-element');
        
        if (elements.length === 0) {
            listDiv.innerHTML = '<small>Nenhum elemento adicionado</small>';
            return;
        }
        
        let html = '<div class="list-group">';
        elements.forEach((el, index) => {
            const type = el.getAttribute('data-type');
            const value = el.getAttribute('data-value');
            html += `
                <div class="list-group-item glass-card mb-2 p-2">
                    <small>
                        <strong>${type.toUpperCase()}</strong><br>
                        ${value ? value.substring(0, 30) : 'Logo'}
                    </small>
                </div>
            `;
        });
        html += '</div>';
        listDiv.innerHTML = html;
    }
    
    // Save layout
    document.getElementById('saveLayoutBtn').addEventListener('click', async function() {
        const canvas = document.getElementById('ticketCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        const elements = canvas.querySelectorAll('.draggable-element');
        
        const layout = {
            canvas: {
                width: 80,
                height: 120,
                unit: 'mm'
            },
            elements: []
        };
        
        // Canvas dimensions in mm
        const canvasWidthMm = 80;
        const canvasHeightMm = 120;
        
        elements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const translateX = parseFloat(el.getAttribute('data-x')) || 0;
            const translateY = parseFloat(el.getAttribute('data-y')) || 0;
            
            // Get element's position relative to canvas (in pixels)
            const leftPx = rect.left - canvasRect.left;
            const topPx = rect.top - canvasRect.top;
            
            // Convert pixels to mm (relative to canvas size)
            // Ensure coordinates are >= 0 and within canvas bounds
            let xMm = Math.max(0, (leftPx / canvasRect.width) * canvasWidthMm);
            let yMm = Math.max(0, (topPx / canvasRect.height) * canvasHeightMm);
            
            // Clamp to canvas bounds
            xMm = Math.min(xMm, canvasWidthMm);
            yMm = Math.min(yMm, canvasHeightMm);
            
            layout.elements.push({
                type: el.getAttribute('data-type'),
                value: el.getAttribute('data-value'),
                x: Math.round(xMm * 10) / 10,  // Round to 1 decimal (mm)
                y: Math.round(yMm * 10) / 10,  // Round to 1 decimal (mm)
                size: parseInt(el.getAttribute('data-size')) || 12
            });
        });
        
        console.log('Saving layout with mm coordinates:', layout);
        
        // Send to backend
        try {
            const response = await fetch('/admin/eventos/layout/{{ evento.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ layout_ingresso: layout })
            });
            
            if (response.ok) {
                showToast('Layout salvo com sucesso!', 'success');
            } else {
                const errorText = await response.text();
                console.error('Save failed:', errorText);
                showToast('Erro ao salvar layout', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Erro ao salvar layout', 'danger');
        }
    });
    
    // Clear all elements
    document.getElementById('clearLayoutBtn').addEventListener('click', function() {
        if (confirm('Deseja remover TODOS os elementos do layout?')) {
            const canvas = document.getElementById('ticketCanvas');
            canvas.innerHTML = '';
            updateElementsList();
            showToast('Layout limpo', 'success');
        }
    });
    
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        const container = document.querySelector('.toast-container');
        container.innerHTML = toastHtml;
        const toastEl = container.querySelector('.toast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
</script>
{% endblock %}

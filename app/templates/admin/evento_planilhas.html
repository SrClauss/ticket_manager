{% extends 'admin/base.html' %}
{% block content %}
<!-- Neomorphic planilhas UI (compact session) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; color:#44474a; }
  .nm-flat{ background:#e0e5ec; box-shadow:9px 9px 16px rgba(163,177,198,0.6), -9px -9px 16px rgba(255,255,255,0.5); }
  .nm-inset{ background:#e0e5ec; box-shadow: inset 6px 6px 12px #bec3c9, inset -6px -6px 12px #ffffff; }
  .nm-button{ background:#e0e5ec; box-shadow:6px 6px 12px #bec3c9, -6px -6px 12px #ffffff; transition:all .2s ease-in-out; }
  .nm-button:active{ box-shadow: inset 4px 4px 8px #bec3c9, inset -4px -4px 8px #ffffff; transform:scale(.98); }
  .nm-card{ border-radius:20px; padding:24px; border:1px solid rgba(255,255,255,0.2); }
  .token-display{ word-break:break-all; font-family:monospace; font-size:0.8rem; color:#d1127c; }
  .progress-bar-bg{ height:12px; border-radius:10px; background:#e0e5ec; box-shadow: inset 3px 3px 6px #bec3c9, inset -3px -3px 6px #ffffff; overflow:hidden; }
  .progress-bar-fill{ height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#60a5fa); box-shadow:0 0 8px rgba(59,130,246,0.5); border-radius:10px; }
  .page-header h1{ font-size:1.75rem; color:#374151; }
  .grid{ display:grid; gap:1rem; }
  .grid-cols-4{ grid-template-columns: repeat(4,1fr); }
  .stack{ display:flex; gap:1rem; }
  .upload-area input[type=file]{ display:inline-block; }
  .toast{ position:fixed; right:20px; top:20px; background:#111827;color:#fff;padding:12px 16px;border-radius:8px; box-shadow: 6px 6px 12px rgba(0,0,0,0.15); display:none; z-index:1000; }
  .tipo-list{ display:flex; flex-direction:column; gap:0.5rem; }
  .tipo-item{ display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:0.5rem; border-radius:12px; background:#e9eef5; }
  @media (max-width:900px){ .grid-cols-4{ grid-template-columns: 1fr; } }
</style>

<div class="max-w-7xl mx-auto">
  <header class="mb-6">
    <h1>Planilhas – {{ evento.nome }}</h1>
    <p class="text-slate-500">Campos, modelo, upload e histórico — tudo em uma sessão.</p>
  </header>

  <div class="grid grid-cols-4 nm-card nm-flat">
    <!-- Modelo oficial / Download -->
    <div class="nm-card nm-flat nm-inset">
      <h2 class="text-xl font-semibold mb-3">Modelo oficial</h2>
      <p class="text-sm text-slate-500 mb-4">Baixe o modelo atualizado com as colunas necessárias.</p>
      <button id="downloadModelBtn" class="nm-button w-full py-3 rounded-xl text-blue-600 font-medium">Baixar modelo (.xlsx)</button>
    </div>

    <!-- Campos e Inscrições (single form) -->
    <div class="nm-card nm-flat">
      <h2 class="text-xl font-semibold mb-3">Campos e Inscrições</h2>
      <p class="text-sm text-slate-500 mb-4">Defina campos obrigatórios e ative inscrições públicas em uma única sessão.</p>
      <form id="settingsForm" method="post" action="/admin/eventos/{{ evento.id }}/planilhas/campos">
        <div style="margin-bottom:8px; font-weight:600">Campos obrigatórios</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          {% for campo in campos_base %}
            <label style="opacity:.7"><input type="checkbox" checked disabled> {{ campo }}</label>
          {% endfor %}
          {% for campo in campos_opcionais %}
            <label><input type="checkbox" name="campos" value="{{ campo }}" {% if campo in campos_atual %}checked{% endif %}> {{ campo }}</label>
          {% endfor %}
        </div>
        <hr style="margin:12px 0">
        <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" name="aceita_inscricoes" {% if evento.aceita_inscricoes %}checked{% endif %}> Aceitar inscrições públicas</label>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button type="submit" class="nm-button px-4 py-2">Salvar</button>
          <button type="button" id="regenerateTokenBtn" class="nm-button px-4 py-2">Gerar/Regenerar token</button>
        </div>
        {% if evento.token_inscricao %}
          <div style="margin-top:10px" class="nm-inset p-3 rounded-lg">
            <p class="text-[10px] uppercase font-bold text-slate-400 mb-1">Link Público</p>
            <a href="/inscricao/{{ evento.nome_normalizado or evento.id }}" class="text-blue-500 text-xs underline block">/inscricao/{{ evento.nome_normalizado or evento.id }}</a>
            <p class="text-[10px] uppercase font-bold text-slate-400 mt-2 mb-1">Token</p>
            <div class="token-display">{{ evento.token_inscricao }}</div>
          </div>
        {% endif %}
      </form>
    </div>

    <!-- Upload -->
    <div class="nm-card nm-flat">
      <h2 class="text-xl font-semibold mb-3">Enviar planilha</h2>
      <p class="text-sm text-slate-500 mb-4">Envie .xlsx ou .csv e acompanhe o processamento.</p>
      <div class="nm-inset p-4 rounded-xl" style="display:flex;gap:8px;align-items:center;">
        <input type="file" id="planilhaFile" accept=".xlsx,.csv" />
        <button id="uploadBtn" class="nm-button px-4 py-2">Enviar Arquivo</button>
      </div>
      <div class="progress-bar-bg mt-4"><div id="progressFill" class="progress-bar-fill"></div></div>
      <p class="text-right text-[10px] mt-2 font-bold text-slate-400" id="progressText">PROCESSANDO 0%</p>
    </div>

    <!-- Empresas / Links -->
    <div class="nm-card nm-flat">
      <h2 class="text-xl font-semibold mb-3">Upload por empresas</h2>
      <p class="text-sm text-slate-500 mb-4">Gerencie links dedicados para parceiros.</p>
      <a href="/admin/eventos/{{ evento.id }}/planilhas/empresas" class="nm-button inline-block px-4 py-2">Gerenciar links</a>

      <hr style="margin:12px 0">
      <h3 class="font-semibold">Tipos de ingresso (definir padrão)</h3>
      <div class="tipo-list" id="tipoList">
        {% for t in evento.get('tipos_ingresso', []) %}
          <div class="tipo-item">
            <div>
              <div style="font-weight:600">{{ t.descricao }}</div>
              <div style="font-size:12px;color:#6b7280">Numero: {{ t.numero }} {% if t.padrao %}<strong>(Padrão)</strong>{% endif %}</div>
            </div>
            <div>
              {% if not t.padrao %}
                <button class="nm-button" onclick="setDefault('{{ t._id if t._id else t.id if t.id else t.numero }}')">Marcar como padrão</button>
              {% else %}
                <span style="font-weight:600;color:#0f5132">Padrão</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Histórico -->
  <section class="nm-card nm-flat mt-6">
    <h2 class="text-xl font-semibold mb-4">Histórico de importações</h2>
    {% if importacoes %}
      <div style="overflow:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead style="background:#f3f4f6">
            <tr><th style="padding:8px">Arquivo</th><th>Data</th><th>Status</th><th>Resumo</th><th>Ações</th></tr>
          </thead>
          <tbody>
            {% for item in importacoes %}
              <tr style="border-bottom:1px solid #eef2f7">
                <td style="padding:8px">{{ item.filename }}</td>
                <td>{{ item.created_at_display }}</td>
                <td>{{ item.status }}</td>
                <td>Linhas: {{ item.stats.total }} • Erros: {{ item.stats.erros }}</td>
                <td><button class="nm-button" onclick="downloadReport('{{ item.id }}')">Baixar JSON</button></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-slate-500">Nenhum upload registrado.</p>
    {% endif %}
  </section>

</div>

<div id="toast" class="toast"></div>

<script>
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',4000); }
function getCookie(name){ const v=`; ${document.cookie}`; const p=v.split(`; ${name}=`); if(p.length===2) return p.pop().split(';').shift(); }

// Download model via fetch to avoid redirect error pages
document.getElementById('downloadModelBtn').addEventListener('click', async function(){
  try{
    const resp = await fetch('/api/admin/eventos/{{ evento.id }}/planilha-modelo', { method:'GET' });
    if(!resp.ok){ toast('Erro ao gerar modelo.'); return; }
    const blob = await resp.blob();
    const cd = resp.headers.get('Content-Disposition') || '';
    let filename = 'modelo_{{ evento.id }}.xlsx';
    const m = cd.match(/filename="?([^\";]+)"?/);
    if(m) filename = m[1];
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    toast('Download iniciado');
  }catch(e){ console.error(e); toast('Erro de rede ao baixar modelo'); }
});

// regenerate token via simple POST to inscrições endpoint: submit form with regenerate
document.getElementById('regenerateTokenBtn').addEventListener('click', function(){
  const form = document.getElementById('settingsForm'); const input = document.createElement('input'); input.type='hidden'; input.name='regenerate'; input.value='1'; form.appendChild(input); form.submit();
});

// Upload handling (reuse existing endpoint)
async function handleUpload(){
  const fileInput=document.getElementById('planilhaFile'); if(!fileInput.files.length){ toast('Selecione um arquivo'); return; }
  const file=fileInput.files[0]; const form=new FormData(); form.append('file', file);
  const token=getCookie('admin_jwt'); const headers={}; if(token) headers['Authorization']='Bearer '+token;
  const resp = await fetch(`/api/admin/eventos/{{ evento.id }}/planilha-upload`, { method:'POST', body: form, headers });
  if(!resp.ok){ const txt=await resp.text(); toast('Erro ao enviar: '+ (txt || resp.status)); return; }
  const data = await resp.json(); const importId = data.import_id; if(!importId){ toast('Upload enviado'); setTimeout(()=>location.reload(),1200); return; }
  toast('Processando...');
  // poll
  const pollUrl = `/api/admin/eventos/{{ evento.id }}/planilha-importacao/${importId}`;
  const progressFill = document.getElementById('progressFill'); const progressText = document.getElementById('progressText');
  const iv = setInterval(async ()=>{
    try{ const r=await fetch(pollUrl); if(!r.ok) return; const s=await r.json(); const processed=(s.progress && s.progress.processed)||0; const total=(s.progress && s.progress.total)||null; const pct = total? Math.round((processed/total)*100): (processed%100); progressFill.style.width=pct+'%'; progressText.textContent=`PROCESSANDO ${pct}%`; if(s.status && s.status!=='processing'){ clearInterval(iv); toast('Processamento finalizado: '+s.status); setTimeout(()=>location.reload(),900); } }catch(e){ console.error(e); }
  },800);
}

document.getElementById('uploadBtn').addEventListener('click', handleUpload);

// Download report
async function downloadReport(importId){ try{ const r = await fetch(`/api/admin/eventos/{{ evento.id }}/planilha-importacao/${importId}`); if(!r.ok){ toast('Erro ao obter relatório'); return; } const data=await r.json(); const blob=new Blob([JSON.stringify(data.relatorio||data, null,2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`relatorio_${importId}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('Download iniciado'); }catch(e){ console.error(e); toast('Erro ao baixar relatório'); } }

// Set default tipo via PUT
async function setDefault(tipoId){ try{ const token=getCookie('admin_jwt'); const headers={'Content-Type':'application/json'}; if(token) headers['Authorization']='Bearer '+token; const resp = await fetch(`/api/tipos-ingresso/${tipoId}`, { method:'PUT', headers, body: JSON.stringify({padrao:true}) }); if(!resp.ok){ const txt=await resp.text(); toast('Falha ao definir padrão: '+(txt||resp.status)); return; } toast('Tipo configurado como padrão'); setTimeout(()=>location.reload(),900); }catch(e){ console.error(e); toast('Erro ao definir padrão'); } }
</script>

{% endblock %}

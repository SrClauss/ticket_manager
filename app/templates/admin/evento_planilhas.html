{% extends 'admin/base.html' %}
{% block content %}
<style>
  .planilha-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  .planilha-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.5rem;
    background: #fff;
  }
  .planilha-card h3 {
    margin-top: 0;
  }
  .campos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.5rem 1rem;
    margin: 1rem 0;
  }
  .campo-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.95rem;
  }
  .status-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.1rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
    text-transform: capitalize;
  }
  .status-completed { background: #d1f5e3; color: #126e3a; }
  .status-partial { background: #fff4d7; color: #8c6d1d; }
  .status-failed { background: #ffe1e1; color: #b3261e; }
  .status-pending { background: #e0e0e0; color: #424242; }
  .upload-area {
    border: 1px dashed #bbb;
    padding: 1rem;
    border-radius: 8px;
    background: #fafafa;
  }
  .history-table {
    width: 100%;
    border-collapse: collapse;
  }
  .history-table th,
  .history-table td {
    border-bottom: 1px solid #e0e0e0;
    padding: 0.75rem;
    text-align: left;
    vertical-align: top;
  }
  .history-table th {
    background: #f5f5f5;
  }
  .relatorio-viewer {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background: #111;
    color: #0f0;
    max-height: 260px;
    overflow: auto;
  }
  .alert-success {
    background: #d1f5e3;
    color: #0f5132;
    border: 1px solid #a3e4c5;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
  }
  .btn-link {
    background: none;
    border: none;
    color: #1a73e8;
    cursor: pointer;
    padding: 0;
  }
  .btn-link:hover {
    text-decoration: underline;
  }
</style>

<div class="page-header">
  <h1>Planilhas – {{ evento.nome }}</h1>
  <p>Configure os campos obrigatórios, gere o modelo, importe participantes e acompanhe o histórico.</p>
</div>

{% if saved %}
  <div class="alert-success">Campos obrigatórios atualizados com sucesso.</div>
{% endif %}
{% if request.query_params.get('insc_saved') == '1' %}
  <div class="alert-success">Configurações de inscrição atualizadas com sucesso.</div>
{% elif request.query_params.get('insc_error') == '1' %}
  <div class="alert-success" style="background:#ffe1e1;color:#b3261e;border-color:#f5c6cb">Não é possível ativar inscrições públicas: inclua Nome, Email e CPF nos campos obrigatórios.</div>
{% endif %}

<div class="planilha-grid">
  <div class="planilha-card">
    <h3>Modelo oficial</h3>
    <p>Faça download do modelo atualizado contendo as colunas obrigatórias do evento.</p>
    <a class="btn" href="/api/admin/eventos/{{ evento.id }}/planilha-modelo">Baixar modelo (.xlsx)</a>
  </div>

  <div class="planilha-card">
    <h3>Campos obrigatórios da planilha</h3>
    <form method="post" action="/admin/eventos/{{ evento.id }}/planilhas/campos">
      <div class="campos-grid">
        {% for campo in campos_base %}
          <label class="campo-item">
            <input type="checkbox" checked disabled>
            {{ campo }} (fixo)
          </label>
        {% endfor %}

        {% for campo in campos_opcionais %}
          <label class="campo-item">
            <input type="checkbox" name="campos" value="{{ campo }}" {% if campo in campos_atual %}checked{% endif %}>
            {{ campo }}
          </label>
        {% endfor %}
      </div>
      <button class="btn" type="submit">Salvar campos</button>
    </form>
  </div>

  <div class="planilha-card">
    <h3>Inscrições públicas</h3>
    <p>Ative inscrições públicas e gere o token público para o formulário de inscrição.</p>
    <form method="post" action="/admin/eventos/{{ evento.id }}/planilhas/inscricoes">
      <label class="campo-item">
        <input type="checkbox" name="aceita_inscricoes" {% if evento.aceita_inscricoes %}checked{% endif %}>
        Aceitar inscrições públicas
      </label>
      <div style="margin-top:0.75rem;">
        <button class="btn" type="submit">Salvar</button>
        <button class="btn" type="submit" name="regenerate" value="1">Gerar/Regenerar token</button>
      </div>
    </form>
    <div style="margin-top:1rem;">
      {% if evento.token_inscricao %}
        <div>Link público: <a href="/inscricao/{{ evento.nome_normalizado or evento.id }}" target="_blank">/inscricao/{{ evento.nome_normalizado or evento.id }}</a></div>
        <div>Token público: <code>{{ evento.token_inscricao }}</code></div>
      {% else %}
        <div>Token não gerado.</div>
      {% endif %}
    </div>
  </div>

  <div class="planilha-card">
    <h3>Upload por empresas</h3>
    <p>Empresas parceiras podem enviar planilhas através de um link público dedicado. Gere links de upload e compartilhe com as empresas responsáveis.</p>
    <div>
      <a class="btn" href="/admin/eventos/{{ evento.id }}/planilhas/empresas">Gerenciar links de upload</a>
    </div>
  </div>
</div>

<div class="planilha-card upload-area">
  <h3>Enviar planilha</h3>
  <p>Envie um arquivo .xlsx ou .csv. Acompanhe o progresso abaixo enquanto a planilha é processada.</p>
  <div style="display:flex;gap:0.5rem;align-items:center;">
    <input type="file" id="planilhaFile" accept=".xlsx,.csv" />
    <button class="btn" id="uploadBtn" type="button">Enviar</button>
  </div>
  <div id="uploadWrapper" style="margin-top:0.75rem;">
    <div style="background:#eee;border-radius:6px;overflow:hidden;height:12px;">
      <div id="uploadProgress" style="width:0%;height:12px;background:#1a73e8;"></div>
    </div>
    <div id="uploadStatus" style="margin-top:0.5rem;font-size:0.9rem;color:#424242;"></div>
    <pre id="uploadResult" style="margin-top:0.5rem;max-height:200px;overflow:auto;background:#fff;padding:0.5rem;border:1px solid #eee;"></pre>
  </div>
</div>

<div class="planilha-card">
  <h3>Histórico de importações</h3>
  {% if importacoes %}
    <div class="table-responsive">
      <table class="history-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Arquivo</th>
            <th>Status</th>
            <th>Resumo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for item in importacoes %}
            <tr>
              <td>{{ item.created_at_display }}</td>
              <td>{{ item.filename }}</td>
              <td>
                <span class="status-chip status-{{ item.status|lower }}">{{ item.status }}</span>
              </td>
              <td>
                <div>Total linhas: <strong>{{ item.stats.total }}</strong></div>
                <div>Ingressos criados: <strong>{{ item.stats.criados }}</strong></div>
                <div>Participantes criados: <strong>{{ item.stats.participantes }}</strong></div>
                <div>Erros: <strong>{{ item.stats.erros }}</strong></div>
              </td>
              <td>
                <button class="btn-link" type="button" data-import-id="{{ item.id }}" onclick="showReport(this)">Ver relatório</button><br/>
                <button class="btn-link" type="button" data-import-id="{{ item.id }}" onclick="downloadReport(this)">Baixar JSON</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>Nenhum upload registrado para este evento.</p>
  {% endif %}

  <pre id="relatorioViewer" class="relatorio-viewer" hidden></pre>
</div>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

window.planilhaHistorico = {{ importacoes | tojson }};

async function handleUpload() {
  const fileInput = document.getElementById('planilhaFile');
  const result = document.getElementById('uploadResult');
  const statusDiv = document.getElementById('uploadStatus');
  const progressBar = document.getElementById('uploadProgress');
  result.textContent = '';
  statusDiv.textContent = '';
  progressBar.style.width = '0%';

  if (!fileInput.files.length) {
    alert('Selecione um arquivo');
    return;
  }

  const file = fileInput.files[0];
  const form = new FormData();
  form.append('file', file);

  const token = getCookie('admin_jwt');
  const headers = {};
  if (token) headers['Authorization'] = 'Bearer ' + token;

  const resp = await fetch(`/api/admin/eventos/{{ evento.id }}/planilha-upload`, {
    method: 'POST',
    body: form,
    headers
  });

  let data;
  try {
    data = await resp.json();
  } catch (e) {
    result.textContent = 'Erro inesperado na resposta do servidor.';
    return;
  }

  if (!resp.ok) {
    result.textContent = JSON.stringify(data, null, 2);
    return;
  }

  const importId = data.import_id;
  if (!importId) {
    result.textContent = JSON.stringify(data, null, 2);
    setTimeout(() => window.location.reload(), 1500);
    return;
  }

  statusDiv.textContent = 'Processando...';
  const pollUrl = `/api/admin/eventos/{{ evento.id }}/planilha-importacao/${importId}`;
  const interval = setInterval(async () => {
    try {
      const sresp = await fetch(pollUrl);
      if (!sresp.ok) return;
      const sdata = await sresp.json();
      const processed = sdata.progress && sdata.progress.processed ? sdata.progress.processed : 0;
      const total = sdata.progress && sdata.progress.total ? sdata.progress.total : null;
      if (total) {
        const pct = Math.min(100, Math.round((processed / total) * 100));
        progressBar.style.width = pct + '%';
        statusDiv.textContent = `Processados ${processed} de ${total}`;
      } else {
        progressBar.style.width = Math.min(100, (processed % 100)) + '%';
        statusDiv.textContent = `Processados ${processed}`;
      }
      if (sdata.status && sdata.status !== 'processing') {
        clearInterval(interval);
        result.textContent = JSON.stringify(sdata.relatorio || sdata, null, 2);
        statusDiv.textContent = 'Finalizado: ' + sdata.status;
        setTimeout(() => window.location.reload(), 1500);
      }
    } catch (e) {
      console.error(e);
    }
  }, 800);
}

function findReport(importId) {
  return window.planilhaHistorico.find(item => item.id === importId);
}

function showReport(button) {
  const importId = button.dataset.importId;
  const viewer = document.getElementById('relatorioViewer');
  const registro = findReport(importId);

  if (!registro) {
    viewer.hidden = false;
    viewer.textContent = 'Relatório não encontrado.';
    return;
  }

  viewer.hidden = false;
  viewer.textContent = JSON.stringify(registro.relatorio, null, 2);
  viewer.scrollIntoView({ behavior: 'smooth' });
}

function downloadReport(button) {
  const importId = button.dataset.importId;
  const registro = findReport(importId);
  if (!registro) {
    alert('Relatório não encontrado.');
    return;
  }

  const blob = new Blob([JSON.stringify(registro.relatorio, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  const sanitizedName = (registro.filename || 'planilha').replace(/\s+/g, '_');
  link.href = url;
  link.download = `relatorio_${sanitizedName}_${importId}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

document.getElementById('uploadBtn').addEventListener('click', handleUpload);
</script>
{% endblock %}

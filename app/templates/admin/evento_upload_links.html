{% extends 'admin/base.html' %}
{% block content %}
<div class="md-card p-4">
  <h2 class="text-lg font-semibold text-slate-100">Links de Upload - {{ evento.nome }}</h2>
  <p class="text-sm text-slate-400">Gere links públicos para que empresas possam enviar planilhas para este evento.</p>

  <form id="generate-link-form" method="post" action="/admin/eventos/{{ evento.id }}/planilhas/empresas/generate" class="mt-4 mb-4">
    <label class="text-sm text-slate-300">Descrição do link (opcional)</label>
    <input type="text" name="descricao" class="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 px-3 text-slate-100" />
    <div class="mt-2 flex items-center gap-3">
      <button id="generate-link-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 text-slate-900 rounded-lg">Gerar link de upload</button>
      <span id="generate-loading" class="text-slate-400" style="display:none">Gerando...</span>
    </div>
  </form>

  {% if links %}
    <div id="linksContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {% for l in links %}
      <div class="mb-3" data-token="{{ l.token }}">
        <div class="md-card p-3 flex flex-col">
          <div class="w-full flex justify-between items-start">
            <div>
              <div class="text-xs text-slate-400">Token</div>
              <code class="text-slate-100">{{ l.token[:12] }}...</code>
            </div>
            <div class="flex items-center gap-2">
              <button class="copy-link-btn inline-flex items-center px-3 py-1 bg-slate-700 text-slate-100 rounded-md" data-link="{{ url_root }}/upload/{{ l.token }}">Copiar</button>
              <a class="inline-flex items-center px-3 py-1 bg-slate-700 text-slate-100 rounded-md" href="{{ url_root }}/upload/{{ l.token }}" target="_blank" rel="noopener">Abrir</a>
              <button class="delete-link-btn inline-flex items-center px-3 py-1 bg-red-600 text-white rounded-md" data-token="{{ l.token }}" title="Excluir link">Excluir</button>
            </div>
          </div>
          <div class="mt-2 w-full">
            <div class="text-xs text-slate-400">Link</div>
            <div style="word-break:break-all;"><a class="text-blue-400 underline" href="{{ url_root }}/upload/{{ l.token }}" target="_blank" rel="noopener">{{ url_root }}/upload/{{ l.token }}</a></div>
            <div class="text-slate-400 text-xs mt-2">Criado: {{ l.created }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-slate-400">Nenhum link gerado ainda.</p>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  async function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try { await navigator.clipboard.writeText(text); return true; } catch (e) { /* fallback below */ }
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
        return true;
      } catch (e) { return false; }
    }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.copy-link-btn').forEach(btn => {
      btn.addEventListener('click', async function(){
        const link = this.dataset.link;
        try{ const ok = await copyToClipboard(link); if (ok) { alert('Link copiado'); } else { alert('Falha ao copiar'); } }catch(e){ alert('Falha ao copiar'); }
      });
    });

    // AJAX form submission for generating links
    const form = document.getElementById('generate-link-form');
    if (form) {
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const btn = document.getElementById('generate-link-btn');
        const loading = document.getElementById('generate-loading');
        btn.disabled = true; loading.style.display = 'inline';
        const formData = new FormData(form);
        try {
          const resp = await fetch(form.action, { method: 'POST', body: formData, headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } });
          if (!resp.ok) throw new Error('Failed to generate');
          const data = await resp.json();
          // prepend new card to list
          const container = document.getElementById('linksContainer');
          if (container) {
            const col = document.createElement('div'); col.className = 'mb-3';
            const card = document.createElement('div'); card.className = 'md-card p-3 flex flex-col';
            card.innerHTML = `
              <div class="w-full flex justify-between items-start">
                <div>
                  <div class="text-xs text-slate-400">Token</div>
                  <code class="text-slate-100">${data.token.slice(0,12)}...</code>
                </div>
                <div class="flex items-center gap-2">
                  <button class="copy-link-btn inline-flex items-center px-3 py-1 bg-slate-700 text-slate-100 rounded-md" data-link="${data.url}">Copiar</button>
                  <a class="inline-flex items-center px-3 py-1 bg-slate-700 text-slate-100 rounded-md" href="${data.url}" target="_blank" rel="noopener">Abrir</a>
                </div>
              </div>
              <div class="mt-2 w-full">
                <div class="text-xs text-slate-400">Link</div>
                <div style="word-break:break-all;"><a class="text-blue-400 underline" href="${data.url}" target="_blank" rel="noopener">${data.url}</a></div>
                <div class="text-slate-400 text-xs mt-2">Criado: ${new Date(data.created).toLocaleString()}</div>
              </div>
            `;
            col.appendChild(card);
            // insert at top
            container.insertBefore(col, container.firstChild);

            // attach copy handlers
            document.querySelectorAll('.copy-link-btn').forEach(btn => {
              btn.addEventListener('click', async function(){ const link = this.dataset.link; await copyToClipboard(link); alert('Link copiado'); });
            });

            // attach delete handlers
            document.querySelectorAll('.delete-link-btn').forEach(btn => {
              btn.addEventListener('click', async function(){
                if (!confirm('Confirma exclusão deste link de upload?')) return;
                const token = this.dataset.token;
                const eventoId = '{{ evento.id }}';
                try {
                  const resp = await fetch(`/admin/eventos/${eventoId}/planilhas/empresas/${token}`, { method: 'DELETE', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } });
                  if (!resp.ok) throw new Error('delete failed');
                  const data = await resp.json();
                  if (data.deleted) {
                    // remove the card
                    const col = this.closest('[data-token]');
                    if (col) col.remove();
                    alert('Link excluído');
                  } else {
                    alert('Link não encontrado');
                  }
                } catch (err) {
                  alert('Falha ao excluir link');
                }
              });
            });
          }
        } catch (err) {
          alert('Falha ao gerar link');
        } finally {
          btn.disabled = false; loading.style.display = 'none';
        }
      });
    }

  });
</script>
{% endblock %}

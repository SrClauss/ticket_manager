{% extends 'admin/base.html' %}
{% block content %}
<div class="glass-card p-4">
  <h2>Links de Upload - {{ evento.nome }}</h2>
  <p>Gere links públicos para que empresas possam enviar planilhas para este evento.</p>

  <form method="post" action="/admin/eventos/{{ evento.id }}/planilhas/empresas/generate" style="margin-bottom:1rem;">
    <label class="form-label">Descrição do link (opcional)</label>
    <input type="text" name="descricao" class="form-control" />
    <button class="btn btn-gradient mt-2">Gerar link de upload</button>
  </form>

  {% if links %}
    <div class="row">
      {% for l in links %}
      <div class="col-md-4 mb-3">
        <div class="glass-card p-3 d-flex flex-column align-items-start">
          <div class="w-100 d-flex justify-content-between align-items-start">
            <div>
              <div class="small text-muted">Token</div>
              <code>{{ l.token[:12] }}...</code>
            </div>
            <div>
              <button class="btn btn-sm btn-glass copy-link-btn" data-link="{{ url_root }}/upload/{{ l.token }}">Copiar</button>
              <a class="btn btn-sm btn-outline ms-1" href="{{ url_root }}/upload/{{ l.token }}" target="_blank" rel="noopener">Abrir</a>
            </div>
          </div>
          <div class="mt-2 w-100">
            <div class="small text-muted">Link</div>
            <div style="word-break:break-all;"><a href="{{ url_root }}/upload/{{ l.token }}" target="_blank" rel="noopener">{{ url_root }}/upload/{{ l.token }}</a></div>
            <div class="text-muted small mt-2">Criado: {{ l.created }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Nenhum link gerado ainda.</p>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  async function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try { await navigator.clipboard.writeText(text); return true; } catch (e) { /* fallback below */ }
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
        return true;
      } catch (e) { return false; }
    }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.copy-link-btn').forEach(btn => {
      btn.addEventListener('click', async function(){
        const link = this.dataset.link;
        try{ const ok = await copyToClipboard(link); if (ok) { alert('Link copiado'); } else { alert('Falha ao copiar'); } }catch(e){ alert('Falha ao copiar'); }
      });
    });
  });
</script>
{% endblock %}

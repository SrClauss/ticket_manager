{% extends 'admin/base.html' %}
{% block content %}
<div class="glass-card p-4 text-center">
  <h2>Ingresso</h2>
  <p id="meta"></p>
  <img id="ingressoImg" src="" alt="Ingresso" style="max-width:100%;height:auto;border:1px solid #ddd;" />
  <div class="mt-3">
    <a id="downloadLink" class="btn btn-glass" href="#" download>Baixar JPG</a>
    <button id="captureBtn" class="btn btn-gradient">Capturar imagem (abrir câmera)</button>
  </div>
  <script>
    // Force fetch from render endpoint every time using cache-buster
    const renderUrlBase = `/api/eventos/{{ evento_id }}/ingresso/{{ ingresso_id }}/render.jpg`;
    const cacheBuster = `t=${Date.now()}`;
    const renderUrl = `${renderUrlBase}?${cacheBuster}`;
    document.getElementById('ingressoImg').src = renderUrl;
    document.getElementById('downloadLink').href = renderUrl;
  </script>
  <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display:none" />
</div>
<script>
document.getElementById('captureBtn').addEventListener('click', ()=> document.getElementById('cameraInput').click());

document.getElementById('cameraInput').addEventListener('change', async (ev)=>{
  const file = ev.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  // Show captured image in new tab as demo
  window.open(url, '_blank');
});

// fill metadata
fetch('/api/eventos/{{ evento_id }}/ingresso/{{ ingresso_id }}/meta')
  .then(r=>r.json()).then(j=>{
    document.getElementById('meta').textContent = `Nome: ${j.nome || ''} — Tipo: ${j.tipo || ''} — Emitido: ${j.data_emissao || ''}`;
  }).catch(()=>{});
</script>
{% endblock %}

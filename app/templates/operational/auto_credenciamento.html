{% extends "operational/base.html" %}

{% block title %}Auto-Credenciamento{% endblock %}

{% block extra_css %}
<style>
    #qr-reader-self {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .welcome-screen {
        text-align: center;
        padding: 40px 20px;
    }
    
    .welcome-screen h1 {
        font-size: 3rem;
        margin-bottom: 20px;
    }
    
    .instruction-card {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .help-desk-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="glass-card p-5">
            <h1 class="text-glass">Bem-vindo!</h1>
            {% if evento %}
            <h3 class="text-glass-muted mb-4">{{ evento.nome }}</h3>
            {% endif %}
            <p class="text-glass-muted mb-4">Sistema de Auto-Credenciamento</p>
            
            <div class="instruction-card glass-card p-4 mt-4">
                <h5 class="text-glass mb-3">Instruções:</h5>
                <ol class="text-glass-muted text-start">
                    <li class="mb-2">Clique em "Iniciar Credenciamento"</li>
                    <li class="mb-2">Posicione seu QR Code de inscrição na frente da câmera</li>
                    <li class="mb-2">Aguarde a confirmação</li>
                    <li class="mb-2">Seu crachá será impresso automaticamente</li>
                </ol>
            </div>
            
            <button class="btn btn-gradient btn-lg mt-4" onclick="startSelfCredentialing()">
                <i data-lucide="play" style="width: 24px; height: 24px;"></i>
                Iniciar Credenciamento
            </button>
        </div>
    </div>
    
    <!-- Scanner Screen -->
    <div id="scannerScreen" style="display: none;">
        <div class="glass-card p-4 mb-4 text-center">
            <h3 class="text-glass mb-2">Posicione seu QR Code</h3>
            <p class="text-glass-muted">Mantenha o código centralizado na câmera</p>
        </div>
        
        <div class="glass-card p-4 text-center">
            <div id="qr-reader-self"></div>
            <p class="text-glass-muted mt-3" id="scannerStatusSelf">Scanner ativo...</p>
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-glass" onclick="cancelSelfCredentialing()">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                Cancelar
            </button>
        </div>
    </div>
    
    <!-- Success Screen -->
    <div id="successScreen" style="display: none;">
        <div class="glass-card p-5 text-center">
            <div class="mb-4">
                <i data-lucide="check-circle" style="width: 100px; height: 100px;" class="text-success"></i>
            </div>
            <h2 class="text-glass mb-3">Credenciamento Realizado!</h2>
            <p class="text-glass-muted mb-4" id="participantName">Nome do Participante</p>
            <div class="alert alert-info glass-card">
                <i data-lucide="printer" style="width: 24px; height: 24px;"></i>
                <p class="mb-0 mt-2">Seu crachá está sendo impresso...</p>
            </div>
            <button class="btn btn-gradient mt-4" onclick="resetSelfCredentialing()">
                Concluir
            </button>
        </div>
    </div>
    
    <!-- Error Screen -->
    <div id="errorScreen" style="display: none;">
        <div class="glass-card p-5 text-center">
            <div class="mb-4">
                <i data-lucide="alert-triangle" style="width: 100px; height: 100px;" class="text-warning"></i>
            </div>
            <h2 class="text-glass mb-3">Ops! Algo deu errado</h2>
            <p class="text-glass-muted mb-4" id="errorMessage">Erro ao processar credenciamento</p>
            <div class="alert alert-warning glass-card">
                <i data-lucide="help-circle" style="width: 24px; height: 24px;"></i>
                <p class="mb-0 mt-2">Por favor, dirija-se ao Help Desk para assistência</p>
            </div>
            <button class="btn btn-gradient mt-4" onclick="resetSelfCredentialing()">
                Tentar Novamente
            </button>
        </div>
    </div>
</div>

<!-- Help Desk Button -->
<button class="btn btn-danger-gradient btn-lg help-desk-btn">
    <i data-lucide="headphones" style="width: 24px; height: 24px;"></i>
    Help Desk
</button>
{% endblock %}

{% block extra_js %}
<!-- Html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    let html5QrCode = null;
    let scanning = false;
    
    async function startSelfCredentialing() {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('scannerScreen').style.display = 'block';
        
        try {
            html5QrCode = new Html5Qrcode("qr-reader-self");
            
            await html5QrCode.start(
                { facingMode: "user" }, // Front camera for self-service
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanError
            );
            
            scanning = true;
            
        } catch (err) {
            console.error('Error starting scanner:', err);
            showError('Erro ao acessar câmera. Verifique as permissões.');
        }
    }
    
    async function cancelSelfCredentialing() {
        if (html5QrCode && scanning) {
            await html5QrCode.stop();
            html5QrCode.clear();
            scanning = false;
        }
        resetSelfCredentialing();
    }
    
    async function onScanSuccess(decodedText, decodedResult) {
        // Stop scanner
        if (html5QrCode && scanning) {
            await html5QrCode.stop();
            html5QrCode.clear();
            scanning = false;
        }
        
        // Process credentialing
        try {
            // In a real implementation, this would call the API
            // For now, we'll simulate the process
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // In production, this would call the API and get the actual participant name
            // For now, we'll simulate success
            showSuccess('[Modo Simulação - Nome será obtido do QR Code]');
            
            // Simulate printing
            await simulatePrinting();
            
        } catch (error) {
            console.error('Error:', error);
            showError('Erro ao processar credenciamento. Por favor, procure o Help Desk.');
        }
    }
    
    function onScanError(errorMessage) {
        // Ignore scan errors
    }
    
    function showSuccess(participantName) {
        document.getElementById('scannerScreen').style.display = 'none';
        document.getElementById('successScreen').style.display = 'block';
        document.getElementById('participantName').textContent = `Bem-vindo(a), ${participantName}!`;
        lucide.createIcons();
    }
    
    function showError(message) {
        document.getElementById('scannerScreen').style.display = 'none';
        document.getElementById('errorScreen').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
        lucide.createIcons();
    }
    
    function resetSelfCredentialing() {
        document.getElementById('welcomeScreen').style.display = 'block';
        document.getElementById('scannerScreen').style.display = 'none';
        document.getElementById('successScreen').style.display = 'none';
        document.getElementById('errorScreen').style.display = 'none';
    }
    
    async function simulatePrinting() {
        // Simulate printing delay
        return new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    // Initialize icons
    lucide.createIcons();
</script>
{% endblock %}
